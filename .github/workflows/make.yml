name: Continuous Integration

on: [push, pull_request, workflow_dispatch]

jobs:
  build_and_coverage:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: configure
      run: |
        LDFLAGS="$CFLAGS" ./autogen.sh  \
            --enable-coverage
    - name: make
      run: make -j
    - name: make check
      run: |
        make -j check || (cat test/test-suite.log; false)

  valgrind_build:
    runs-on: ubuntu-latest

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt -q install valgrind
    - uses: actions/checkout@v4
    - name: configure
      run: |
        LDFLAGS="$CFLAGS" ./autogen.sh  \
            --enable-valgrind
    - name: make
      run: make -j
    - name: make check
      run: |
        make -j check || (cat test/test-suite.log; false)

  ubsan_build:
    runs-on: ubuntu-latest
    env:
      CC: clang
      # TODO: Add -fsanitize=address and memory too.
      CFLAGS: "-fsanitize=undefined
               -fno-omit-frame-pointer
               -fno-sanitize-recover=all
               -fno-sanitize=shift-base"

    steps:
    - uses: actions/checkout@v4
    - name: configure
      run: |
        LDFLAGS="$CFLAGS" ./autogen.sh
    - name: make check
      run: |
        make -j check || (cat test/test-suite.log; false)
